name: ğŸ”’ GitFlow Branch Protection

on:
  pull_request:
    branches: [ main, dev ]
  push:
    branches: [ main, dev ]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # ğŸ” Validate GitFlow Rules
  validate-gitflow:
    name: ğŸ” Validate GitFlow Rules
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Validate branch naming
        run: |
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          echo "ğŸŒ¿ Validating branch: $BRANCH_NAME"
          
          # Allow main and dev branches
          if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "dev" ]]; then
            echo "âœ… Core branch validated"
            exit 0
          fi
          
          # Validate feature branch naming
          if [[ ! "$BRANCH_NAME" =~ ^(feat|fix|docs|style|refactor|test|chore)\/[0-9]+-[a-z0-9-]+$ ]]; then
            echo "âŒ Invalid branch name: $BRANCH_NAME"
            echo "ğŸ“‹ Expected format: <type>/<issue-number>-<description>"
            echo "ğŸ“‹ Examples: feat/123-user-auth, fix/456-login-bug"
            exit 1
          fi
          
          echo "âœ… Feature branch name validated"

      - name: ğŸ¯ Validate PR target branch
        if: github.event_name == 'pull_request'
        run: |
          TARGET_BRANCH="${{ github.base_ref }}"
          SOURCE_BRANCH="${{ github.head_ref }}"
          
          echo "ğŸ”„ PR: $SOURCE_BRANCH â†’ $TARGET_BRANCH"
          
          # Feature branches should target dev
          if [[ "$SOURCE_BRANCH" =~ ^(feat|fix|docs|style|refactor|test|chore)\/ ]]; then
            if [[ "$TARGET_BRANCH" != "dev" ]]; then
              echo "âŒ Feature branches must target 'dev', not '$TARGET_BRANCH'"
              echo "ğŸ’¡ Please change the target branch to 'dev'"
              exit 1
            fi
            echo "âœ… Feature branch correctly targets dev"
          fi
          
          # Only dev should target main
          if [[ "$TARGET_BRANCH" == "main" && "$SOURCE_BRANCH" != "dev" ]]; then
            echo "âŒ Only 'dev' branch can merge to 'main'"
            echo "ğŸ’¡ Feature branches should merge to 'dev' first"
            exit 1
          fi
          
          echo "âœ… PR target validation passed"

  # ğŸ”§ Quality Checks (Required for all branches)
  quality-checks:
    name: ğŸ”§ Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§¹ Lint check
        run: pnpm lint

      - name: ğŸ” Type check
        run: pnpm check-types

      - name: ğŸ—ï¸ Build check
        run: pnpm build

  # ğŸ§ª Test Suite (Required for all branches)
  test-suite:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Run tests
        run: pnpm test

      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # ğŸ” Security Scan (Required for main branch)
  security-scan:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.base_ref == 'main'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run security audit
        run: |
          npm audit --audit-level=moderate
          echo "âœ… Security audit completed"

      - name: ğŸ•µï¸ CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ğŸ“‹ Deployment Preview (for dev branch)
  deployment-preview:
    name: ğŸ“‹ Deployment Preview
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    needs: [quality-checks, test-suite]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build for preview
        run: pnpm build

      - name: ğŸš€ Deploy to staging
        run: |
          echo "ğŸš§ Deploying to staging environment..."
          echo "ğŸ”— Preview URL would be generated here"
          # Add your deployment logic here

  # âœ… Status Check Summary
  gitflow-status:
    name: âœ… GitFlow Status
    runs-on: ubuntu-latest
    needs: [validate-gitflow, quality-checks, test-suite]
    if: always()
    steps:
      - name: ğŸ“Š Check all jobs status
        run: |
          echo "ğŸ” GitFlow Validation: ${{ needs.validate-gitflow.result }}"
          echo "ğŸ”§ Quality Checks: ${{ needs.quality-checks.result }}"
          echo "ğŸ§ª Test Suite: ${{ needs.test-suite.result }}"
          
          if [[ "${{ needs.validate-gitflow.result }}" != "success" ]]; then
            echo "âŒ GitFlow validation failed"
            exit 1
          fi
          
          if [[ "${{ needs.quality-checks.result }}" != "success" ]]; then
            echo "âŒ Quality checks failed"
            exit 1
          fi
          
          if [[ "${{ needs.test-suite.result }}" != "success" ]]; then
            echo "âŒ Test suite failed"
            exit 1
          fi
          
          echo "âœ… All GitFlow requirements satisfied!"

  # ğŸ‰ Auto-merge dev to main (optional, commented for safety)
  # auto-merge-dev:
  #   name: ğŸ‰ Auto-merge dev to main
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/dev' && needs.gitflow-status.result == 'success'
  #   needs: [gitflow-status, security-scan]
  #   steps:
  #     - name: ğŸ¤– Create merge PR
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const pr = await github.rest.pulls.create({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             title: 'ğŸš€ Release: Merge dev to main',
  #             head: 'dev',
  #             base: 'main',
  #             body: 'ğŸ¤– Automated release PR created after successful dev branch validation'
  #           });
  #           console.log(`Created PR: ${pr.data.html_url}`);
